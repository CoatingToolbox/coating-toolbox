
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../buttons/pages-tab-button.html">
<link rel="import" href="../buttons/icon-label-button.html">
<link rel="import" href="../inputs/text-input.html">
<link rel="import" href="../inputs/unit-input.html">
<link rel="import" href="../inputs/item-select-input.html">
<link rel="import" href="../charts/viscosity-chart.html">
<link rel="import" href="../redux/redux-mixin.html">
<link rel="import" href="../data/coating-formula-class.html">
<link rel="import" href="../styles/input-graphic-layout-styles.html">

<dom-module id="coating-editor-page">
  
   <template>
    
    <style include='input-graphic-layout-styles'></style>
    
    <section id='left-section'>
      
      <div class='card highlight top'>
        <div class='card-title'>Coating Formulation Designer</div>
        <div class='card-description'>The Coating Pan Designer estimsates important properties of a coating pan from basic dimensions 
        and descriptions. 
        </div>
      </div>
    
      <!--Description Section-->
      <div class='card'>
        <div class='card-title underline'>Description</div>
        <text-input value='{{coat.productName}}' icon='my-icons:product' label='Product'></text-input>
        <text-input value='{{coat.formulaName}}' icon='my-icons:product' label='Formula'></text-input>
        <text-input value='{{coat.color}}' icon='my-icons:product' label='Color'></text-input>
        <item-select-input label='Functionality' icon='my-icons:product' items='["Immediate", "Delayed", "Extended"]' selected='{{coat.type}}'></item-select-input>
      </div>
      
      <!-- Section-->
      <div class='card'>
        <div class='card-title underline'>Film Properties</div>
        <unit-input value='{{coat.density}}' icon='my-icons:density' label='Film Density' type='density' selected-units='g/ml'></unit-input>
      </div>
      
      <!-- Section-->
      <div class='card'>
        <div class='card-title underline'>Viscosity Profile</div>
        <unit-input value='{{coat.viscosityIntercept}}' icon='my-icons:count' label='Intercept' selected-units=''></unit-input>
        <unit-input value='{{coat.viscosityExponent}}' icon='my-icons:count' label='Exponent' selected-units=''></unit-input>
      </div>
      
      <!-- Section-->
      <div class='card'>
        <div class='card-title underline'>Starting Recommendations</div>
        <unit-input value='{{coat.solids}}' icon='my-icons:percent' label='Dispersion Solids' type='percent' selected-units='%'></unit-input>
      </div>
      
      <div class='card underline'>
        <div class='card-title'>Calculate</div>
        <div class='card-description'>Click save the coating formulation properties</div>
        <icon-label-button class='wide' icon='my-icons:calculator' label='Calculate Coatiing' on-click='_save'></icon-label-button>
      
        <div id='admin-buttons' hidden$='[[!isAdmin]]'>
          <icon-label-button icon='my-icons:save' label='Save Firebase' on-click='_saveToFirebase'></icon-label-button>
          <icon-label-button icon='my-icons:save' label='Update Firebase' on-click='_replaceOnFirebase'></icon-label-button>
        </div>
      </div>  
      
    </section>
    
    
    
    <section id='right-section'>
      
      <iron-selector selected='{{selectedPage}}'>
          <pages-tab-button icon='my-icons:line-chart' label='Viscosity'></pages-tab-button>
      </iron-selector>
      
      <iron-pages selected='[[selectedPage]]'>
        <div class='page'>
          <div class='card-title'>Dispersion Solids vs Viscosity</div>
          <viscosity-chart class='chart' intercept='[[coat.viscosityIntercept]]' exponent='[[coat.viscosityExponent]]' solids='[[coat.solids]]'></viscosity-chart>
        </div>
      </iron-pages>
      
    </section>
    
  </template>

  <script>
    class CoatingEditorPage extends ReduxMixin(Polymer.Element) {
      static get is() { return 'coating-editor-page'; }
      static get properties() {
        return { 
          isAdmin: {type: Boolean, statePath: 'isAdmin'},
          coat: { type: Object, statePath: 'coatingFormula'},
          selectedPage: {type: Number, value: 0}
        };
      }
      _save() {
        this.dispatch({ 
          type: "CALCULATE_COATING_FORMULA",
          value: this.coat
        });
        window.location = '#/materials';
      }
      
      _saveToFirebase() {
        if(!this.isAdmin) { return; }
        
        // /*global firebase */
        this.coat.firebaseKey = firebase.database().ref('coatingFormulas/').push().key;
        let coat =this._coatToJSON();
        firebase.database().ref(`coatingFormulas/${coat.firebaseKey}`).set(coat);
      }
      _replaceOnFirebase() {
        if(!this.isAdmin) { return; }
        
        let coat =this._coatToJSON();
        if(coat.firebaseKey) {
          /*global firebase */
          firebase.database().ref(`coatingFormulas/${coat.firebaseKey}`).set(coat);
        } else {
          console.log('could not replace firebase so loaded as new');
          this._saveToFirebase();
        }
      }
      _coatToJSON() {
        return Object.assign({}, this.coat);
      }
    }

    window.customElements.define(CoatingEditorPage.is, CoatingEditorPage);
  </script>
</dom-module>
